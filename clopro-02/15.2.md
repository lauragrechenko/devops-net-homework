# Домашнее задание к занятию «Вычислительные мощности. Балансировщики нагрузки»  

- Terraform манифесты YC: [src/yc/](src/yc/)
- [yc/cloud-init.yaml](src/yc/cloud-init.yaml)

- Terraform манифесты AWS: [src/aws/](src/aws/)
- [aws/cloud-init.yaml](src/aws/cloud-init.yaml)

---
## Задание 1. Yandex Cloud

**Что нужно сделать**

1. Создать бакет Object Storage и разместить в нём файл с картинкой:

 - Создать бакет в Object Storage с произвольным именем (например, _имя_студента_дата_).
 - Положить в бакет файл с картинкой.
 - Сделать файл доступным из интернета.

#### Выполнили код Terraform:

![alt text](screenshots/yc/s3/00.png)

#### Бакет clopro-dev-bucket-laura-08-02-26 содержит файл pb-logo.png (276 КБ), загруженный сервисным аккаунтом clopro-bucket-sa

![alt text](screenshots/yc/s3/01.png)

#### Сервисный аккаунт clopro-bucket-sa (aje2q1il33thv1egfj3h) создан для работы с Object Storage. Access bindings: Сервисному аккаунту назначена роль storage.editor

![alt text](screenshots/yc/s3/02.png)

#### Файл доступен из интернета по публичной ссылке. Ответ HTTP 200, content-type: image/png - файл корректно отдаётся как изображение

![alt text](screenshots/yc/s3/03.png)
 
2. Создать группу ВМ в public подсети фиксированного размера с шаблоном LAMP и веб-страницей, содержащей ссылку на картинку из бакета:

 - Создать Instance Group с тремя ВМ и шаблоном LAMP. Для LAMP рекомендуется использовать `image_id = fd827b91d99psvq5fjit`.
 - Для создания стартовой веб-страницы рекомендуется использовать раздел `user_data` в [meta_data](https://cloud.yandex.ru/docs/compute/concepts/vm-metadata).
 - Разместить в стартовой веб-странице шаблонной ВМ ссылку на картинку из бакета.
 - Настроить проверку состояния ВМ.
 
3. Подключить группу к сетевому балансировщику:

 - Создать сетевой балансировщик.
 - Проверить работоспособность, удалив одну или несколько ВМ.

### Задания 2-3: Instance Group + NLB
#### Выполнили код Terraform:

![alt text](screenshots/yc/nlb/00.png)

#### Сервисный аккаунт clopro-dev-ig-sa создан для управления Instance Group. 
В access bindings каталога ему назначена роль editor, необходимая для создания и управления ВМ в группе.

![alt text](screenshots/yc/nlb/sa.png)

#### Instance Group clopro-dev-pb-vms-group - 3 ВМ (LAMP-образ). 
- Настроена проверка состояния (HTTP GET / на порту 80). 
- Target group clopro-dev-tg создана автоматически для NLB. 
- Группе назначен сервисный аккаунт clopro-dev-ig-sa
- deploy_policy.strategy: PROACTIVE - стратегия проактивной замены: нездоровые ВМ автоматически пересоздаются без ожидания ручного вмешательства. max_unavailable: 2, max_expansion: 2 - при обновлении допускается одновременно 2 недоступных и 2 дополнительных ВМ сверх целевого размера

![alt text](screenshots/yc/nlb/ig-1.png)

![alt text](screenshots/yc/nlb/ig-2.png)


#### Target group clopro-dev-tg - создана автоматически Instance Group. 
Содержит 3 таргета с внутренними адресами (192.168.10.28, .31, .34) в подсети e9bsaq7jq2agc245ns71

![alt text](screenshots/yc/nlb/tg.png)

#### NLB clopro-dev-nlb - сетевой балансировщик (L4, TCP) 
- с внешним адресом 158.160.224.197:80. 
- Подключена target group enpao7qaad2am4jvl23o. 
- NLB проверяет доступность бэкендов (HTTP GET / на порту 80, интервал 2s).

![alt text](screenshots/yc/nlb/nlb.png)

### Тестирование доступа через NLB:
Веб-страница доступна по внешнему адресу NLB `http://158.160.224.197`. Картинка загружается из Object Storage бакета:

![alt text](screenshots/yc/nlb/01.png)

#### Тестирование отказоустойчивости
- удалили ВМ fhmd60rh88pd4gup42nj. 
- Instance Group автоматически начала пересоздание (статус CREATING_INSTANCE). 
- Веб-страница по-прежнему доступна через NLB - трафик обслуживается оставшимися 2 ВМ. Картинка из Object Storage загружается корректно.

![alt text](screenshots/yc/nlb/ig-delete.png)
 

4. (дополнительно)* Создать Application Load Balancer с использованием Instance group и проверкой состояния.

### Выполнили код Terraform:

![alt text](screenshots/yc/alb/01.png)

### Проверили созданные ресурсы:

#### ALB с внешним адресом `158.160.223.9`, принимающий трафик на порту `80` и направляющий его через HTTP-router `ds78io0i4tm1f3jk2ef6`

![alt text](screenshots/yc/alb/alb.png)

#### HTTP-router (`ds78io0i4tm1f3jk2ef6`) с привязанным virtual host `clopro-dev-virtual-host`

![alt text](screenshots/yc/alb/http-router.png)

#### Virtual host с маршрутом `clopro-dev-route`, направляющим трафик в backend group `ds74etpacvuo33r5s550`

![alt text](screenshots/yc/alb/virtual-host.png)

#### Backend group с HTTP-бэкендом на порту 80, привязанным к target group `ds7e5jtbtf6grhalga35` (healthcheck: HTTP GET / каждую 1s)

![alt text](screenshots/yc/alb/backend-group.png)


#### Target group (создана автоматически instance group) с 3 таргетами:

![alt text](screenshots/yc/alb/target-group.png)

#### Instance group - 3 ВМ запущены и работают:

![alt text](screenshots/yc/alb/ig.png)

- application_load_balancer_state.target_group_id: ds7e5jtbtf6grhalga35 - target group автоматически создана instance group и совпадает с той, что указана в backend group.

- managed_instances_state.running_actual_count: "3" - все 3 ВМ запущены и работают.

- deploy_policy.strategy: PROACTIVE - стратегия проактивной замены: нездоровые ВМ заменяются автоматически без ожидания триггера деплоя.

- load_balancer_state: {} - пустой, т.к. используется ALB, а не NLB.

![alt text](screenshots/yc/alb/ig-2.png)

### Тестирование доступа через ALB:
Веб-страница доступна по внешнему адресу ALB `http://158.160.223.9`. Картинка загружается из Object Storage бакета:

![alt text](screenshots/yc/alb/00.png)

Полезные документы:

- [Compute instance group](https://registry.terraform.io/providers/yandex-cloud/yandex/latest/docs/resources/compute_instance_group).
- [Network Load Balancer](https://registry.terraform.io/providers/yandex-cloud/yandex/latest/docs/resources/lb_network_load_balancer).
- [Группа ВМ с сетевым балансировщиком](https://cloud.yandex.ru/docs/compute/operations/instance-groups/create-with-balancer).

---
## Задание 2*. AWS (задание со звёздочкой)

Это необязательное задание. Его выполнение не влияет на получение зачёта по домашней работе.

**Что нужно сделать**

Используя конфигурации, выполненные в домашнем задании из предыдущего занятия, добавить к Production like сети Autoscaling group из трёх EC2-инстансов с  автоматической установкой веб-сервера в private домен.

1. Создать бакет S3 и разместить в нём файл с картинкой:

 - Создать бакет в S3 с произвольным именем (например, _имя_студента_дата_).
 - Положить в бакет файл с картинкой.
 - Сделать доступным из интернета.

#### Выполнили код Terraform:

![alt text](screenshots/aws/s3/01.png)

#### Файл доступен из интернета по публичной ссылке. Ответ HTTP 200, content-type: image/png - файл корректно отдаётся как изображение

![alt text](screenshots/aws/s3/02.png)

#### Бакет clopro-dev-bucket-laura-10-02-26 содержит файл pb-logo.png

![alt text](screenshots/aws/s3/list-buckets.png)

![alt text](screenshots/aws/s3/list-objects.png)

#### Bucket Policy: разрешает публичный доступ (s3:GetObject) к файлу pb-logo.png для любого пользователя (Principal: *).

![alt text](screenshots/aws/s3/get-bk-policy.png)

#### Public Access Block полностью отключен (все параметры False), что позволяет bucket policy работать

![alt text](screenshots/aws/s3/get-public-access-block.png)

2. Сделать Launch configurations с использованием bootstrap-скрипта с созданием веб-страницы, на которой будет ссылка на картинку в S3. 
3. Загрузить три ЕС2-инстанса и настроить LB с помощью Autoscaling Group.

#### Выполнили код Terraform:

![alt text](screenshots/aws/nlb/00.png)

#### Тестирование доступа через NLB:
Веб-страница доступна по адресу NLB `clopro-dev-nlb-11404c6c95dd195e.elb.eu-central-1.amazonaws.com`. Картинка загружается из Object Storage бакета:

![alt text](screenshots/aws/nlb/01.png)

![alt text](screenshots/aws/nlb/02.png)

### Проверили созданные ресурсы:

#### VPC `clopro-dev-vpc` создан с CIDR-блоком `10.10.0.0/16`

![alt text](screenshots/aws/nlb/vpc.png)

#### Subnets:
- **Public subnet** `10.10.1.0/24` (AZ: eu-central-1a) - `MapPublicIP: True` (автоматическое назначение публичных IP)
- **Private subnet** `10.10.2.0/24` (AZ: eu-central-1a) - `MapPublicIP: False` (без публичных IP)

![alt text](screenshots/aws/nlb/subnets.png)

#### Internet Gateway `clopro-dev-igw` подключен к VPC (State: available)

![alt text](screenshots/aws/nlb/igw.png)

#### NAT Gateway `nat-0caae797cab3a0743` (State: available)
- **Public subnet**: `subnet-08dc8f05a4c11e5eb`
- **Elastic IP**: `3.73.176.79` (Allocation ID: `eipalloc-0042fbac9855796fd`)
- **Private IP**: `10.10.1.72`
- Предоставляет исходящий доступ в интернет для инстансов в private subnet

![alt text](screenshots/aws/nlb/nat-gw.png)

#### Route Tables (таблицы маршрутизации):
- **Public RT** `clopro-dev-public-rt`: ассоциирована с public subnet, маршрут `0.0.0.0/0 → IGW` (прямой выход в интернет)
- **Private RT** `clopro-dev-private-rt`: ассоциирована с private subnet, маршрут `0.0.0.0/0 → NAT Gateway` (выход через NAT, только исходящий трафик)

![alt text](screenshots/aws/nlb/route-tables.png)

#### Security Group `clopro-dev-web-sg` (VPC: `vpc-09310a85bc5118d57`)
![alt text](screenshots/aws/nlb/sg.png)

#### Security-group rules:
- **Ingress (входящий)**: TCP порт 80 из `0.0.0.0/0` - HTTP-трафик от NLB (NLB не использует собственную SG, передаёт трафик напрямую)
  *Примечание*: для большей безопасности можно было бы ограничить ingress до public Subnet CIDR (`10.10.1.0/24`) вместо `0.0.0.0/0`, т.к. NLB находится внутри. Текущая конфигурация работает корректно благодаря тому, что EC2 находятся в private subnet без публичных IP.
  Я решила не пересоздавать ресурсы - текущая версия кода с `0.0.0.0/0`.

- **Egress (исходящий)**: разрешён весь исходящий трафик (`-1` = all protocols, all ports) - необходимо для установки пакетов (`apt install apache2`) через NAT Gateway

![alt text](screenshots/aws/nlb/sg-rules.png)

#### Launch Template `clopro-dev-web-*` (версия 1)
- AMI: Ubuntu 24.04 LTS (автоматический поиск последней версии)
- Instance type: t3.micro
- EBS: gp3, 10 GB, `/dev/sda1`
- User data: cloud-init скрипт для установки Apache и создания index.html с картинкой из S3

![alt text](screenshots/aws/nlb/launch-templates.png)

#### Auto Scaling Group `clopro-dev-web-asg`
- **Размер**: Desired/Min/Max = 3 (фиксированный размер)
- **Subnet**: `subnet-0c2ba58a4f07b9f2b` (private subnet - инстансы без публичных IP)
- **Launch Template**: версия `$Latest` (автоматическое использование последней версии шаблона)
- **Health check**: EC2 (проверка доступности инстанса), grace period 300s
- ASG автоматически регистрирует инстансы в Target Group NLB

![alt text](screenshots/aws/nlb/asg.png)

#### EC2 инстансы (3 шт., управляемые ASG)
- **Type**: t3.micro
- **State**: running
- **Private IPs**: 10.10.2.105, 10.10.2.183, 10.10.2.246
- **Subnet**: `subnet-0c2ba58a4f07b9f2b` (private subnet, AZ: eu-central-1a)
- Без публичных IP-адресов - доступны только через NLB

![alt text](screenshots/aws/nlb/instances.png)

#### Target Group `clopro-dev-tg`
- **Protocol**: TCP, **Port**: 80
- **VPC**: `vpc-09310a85bc5118d57`
- Healthcheck (TCP) проверяет доступность инстансов каждые 30s
- ASG автоматически регистрирует/удаляет инстансы при изменении состава группы

![alt text](screenshots/aws/nlb/target-groups.png)

#### Network Load Balancer `clopro-dev-nlb`
- **Type**: network (L4, TCP)
- **Scheme**: internet-facing (публичный, доступен из интернета)
- **DNS**: `clopro-dev-nlb-11404c6c95dd195e.elb.eu-central-1.amazonaws.com`
- **State**: active
- **Listener**: TCP порт 80 → Target Group `clopro-dev-tg`
- NLB распределяет входящий HTTP-трафик между 3 инстансами в private subnet

![alt text](screenshots/aws/nlb/nlb.png)

![alt text](screenshots/aws/nlb/listeners.png)



Resource Terraform:

- [S3 bucket](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/s3_bucket)
- [Launch Template](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/launch_template).
- [Autoscaling group](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/autoscaling_group).
- [Launch configuration](https://registry.terraform.io/providers/hashicorp/aws/latest/docs/resources/launch_configuration).

Пример bootstrap-скрипта:

```
#!/bin/bash
yum install httpd -y
service httpd start
chkconfig httpd on
cd /var/www/html
echo "<html><h1>My cool web-server</h1></html>" > index.html
```
### Правила приёма работы

Домашняя работа оформляется в своём Git репозитории в файле README.md. Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.
Файл README.md должен содержать скриншоты вывода необходимых команд, а также скриншоты результатов.
Репозиторий должен содержать тексты манифестов или ссылки на них в файле README.md.
