worker_processes  1;

events { worker_connections 1024; }

http {
  sendfile on;

  upstream security_upstream { server security:3000; }
  upstream uploader_upstream { server uploader:3000; }
  upstream minio_upstream    { server storage:9000; }

  server {
    listen 80;

    # --- Public endpoints (no auth) ---
    location = /v1/token {
      proxy_pass http://security_upstream/v1/token;
      proxy_set_header Host $host;
    }

    # --- Auth subrequest ---
    location = /_auth {
      internal;
      proxy_pass http://security_upstream/v1/token/validation;
      proxy_set_header Authorization $http_authorization;
      proxy_set_header Content-Length "";
      proxy_pass_request_body off;
    }

    # --- Protected endpoints ---
    location = /v1/upload {
      auth_request /_auth;

      proxy_pass http://uploader_upstream/v1/upload;
      proxy_set_header Authorization $http_authorization;
      proxy_set_header Host $host;
    }

    # GET /v1/images/{image} -> minio GET /data/{image}
    location ~ ^/v1/images/(.+)$ {
      auth_request /_auth;

      proxy_pass http://minio_upstream/data/$1;
      proxy_set_header Authorization $http_authorization;
      proxy_set_header Host $host;
    }
  }
}